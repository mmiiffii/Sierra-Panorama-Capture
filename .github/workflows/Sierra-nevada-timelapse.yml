name: Timelapse - one of 4 Cams

on:
  workflow_dispatch:
    inputs:
      camera:
        description: "Camera: borreguiles, satelite, stadium, veleta"
        required: true
        default: "borreguiles"
      days_back:
        description: "How many days back (integer >= 1)"
        required: true
        default: "1"
      fps:
        description: "Frames per second (e.g. 24)"
        required: true
        default: "24"

permissions:
  contents: write

jobs:
  timelapse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install numpy opencv-python-headless

      - name: Debug images tree
        run: |
          echo "Repo root:"
          pwd
          echo
          echo "Listing images directory (for sanity):"
          ls -R images || echo "images/ not found"

      - name: Build timelapse video
        id: build
        env:
          CAMERA: ${{ github.event.inputs.camera }}
          DAYS: ${{ github.event.inputs.days_back }}
          FPS: ${{ github.event.inputs.fps }}
          RUN_ID: ${{ github.run_id }}
        run: |
          echo "Camera key: ${CAMERA}"
          echo "Days back: ${DAYS}"
          echo "FPS:       ${FPS}"

          OUT="timelapse_${CAMERA}_run${RUN_ID}.mp4"
          echo "Output will be: ${OUT}"

          python -u scripts/create_timelapse.py \
            --camera "${CAMERA}" \
            --days "${DAYS}" \
            --fps "${FPS}" \
            --output "${OUT}"

          if [ ! -f "${OUT}" ]; then
            echo "ERROR: Expected output video not found: ${OUT}"
            exit 1
          fi

          echo "video_path=${OUT}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: timelapse-${{ github.event.inputs.camera }}-run-${{ github.run_id }}
          release_name: Timelapse - ${{ github.event.inputs.camera }} (run ${{ github.run_number }})
          body: |
            Timelapse for camera: ${{ github.event.inputs.camera }}
            Days back: ${{ github.event.inputs.days_back }}
            FPS: ${{ github.event.inputs.fps }}

            Generated by GitHub Actions (run ${{ github.run_number }}).
          draft: false
          prerelease: false

      - name: Upload video as release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.build.outputs.video_path }}
          asset_name: timelapse-${{ github.event.inputs.camera }}-run-${{ github.run_id }}.mp4
          asset_content_type: video/mp4
