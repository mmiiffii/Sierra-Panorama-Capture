name:  Timelapse - Choose Camera

on:
  workflow_dispatch:
    inputs:
      camera:
        description: "Camera"
        required: true
        type: choice
        options:
          - Borreguiles
          - Stadium
          - Satelite
          - Veleta
        default: Borreguiles
      days_back:
        description: "How many days back"
        required: true
        type: number
        default: 1
      fps:
        description: "Frames per second"
        required: true
        type: number
        default: 24

permissions:
  contents: write

jobs:
  timelapse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install numpy opencv-python-headless

      - name: Build timelapse video
        id: build
        env:
          CAMERA: ${{ github.event.inputs.camera }}
          DAYS: ${{ github.event.inputs.days_back }}
          FPS: ${{ github.event.inputs.fps }}
        run: |
          OUT="timelapse_${CAMERA}_run${{ github.run_id }}.mp4"
          echo "OUTPUT_VIDEO=$OUT" >> "$GITHUB_OUTPUT"

          python -u scripts/create_timelapse.py \
            --camera "${CAMERA}" \
            --days "${DAYS}" \
            --fps "${FPS}" \
            --output "${OUT}"

      - name: Create release
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="timelapse-${{ github.event.inputs.camera }}-run-${{ github.run_id }}"
          NAME="Timelapse ${{ github.event.inputs.camera }} (run ${{ github.run_number }})"
          BODY="Timelapse for camera: ${{ github.event.inputs.camera }}
Days back: ${{ github.event.inputs.days_back }}
FPS: ${{ github.event.inputs.fps }}

Generated by GitHub Actions (run ${{ github.run_number }})."

          API_URL="https://api.github.com/repos/${{ github.repository }}/releases"
          RESP="$(curl -sSL \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d @- \
            "$API_URL" <<EOF
          {
            "tag_name": "$TAG",
            "target_commitish": "${{ github.sha }}",
            "name": "$NAME",
            "body": "$BODY",
            "draft": false,
            "prerelease": false
          }
EOF
          )"

          echo "$RESP" | jq -r '.upload_url' | sed 's/{?name,label}//' > upload_url.txt
          echo "upload_url=$(cat upload_url.txt)" >> "$GITHUB_OUTPUT"

      - name: Upload video as release asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPLOAD_URL: ${{ steps.create_release.outputs.upload_url }}
          VIDEO_PATH: ${{ steps.build.outputs.OUTPUT_VIDEO }}
        run: |
          if [ ! -f "${VIDEO_PATH}" ]; then
            echo "Video file not found: ${VIDEO_PATH}"
            exit 1
          fi

          NAME="$(basename "${VIDEO_PATH}")"
          echo "Uploading ${VIDEO_PATH} to releaseâ€¦"

          curl -sSL \
            -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: video/mp4" \
            --data-binary @"${VIDEO_PATH}" \
            "${UPLOAD_URL}?name=${NAME}"
