name: Sanitize Watch YAML
on: workflow_dispatch
permissions:
  contents: write

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Strip BOM, convert CRLFâ†’LF, replace tabs with spaces
        run: |
          f=".github/workflows/feratel-watch.yml"
          test -f "$f" || { echo "File not found: $f"; exit 1; }

          # strip UTF-8 BOM if present
          python - <<'PY'
p = ".github/workflows/feratel-watch.yml"
b = open(p, "rb").read()
open(p, "wb").write(b[3:] if b[:3] == b"\xEF\xBB\xBF" else b)
PY

          # CRLF -> LF
          sed -i 's/\r$//' "$f"

          # tabs -> two spaces
          perl -0777 -pe 's/\t/  /g' -i "$f"

      - name: Commit if changed
        run: |
          if [ -n "$(git status --porcelain .github/workflows/feratel-watch.yml)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add .github/workflows/feratel-watch.yml
            git commit -m "sanitize watch workflow (strip BOM, LF endings, spaces)"
            git push
          else
            echo "No changes."
          fi
