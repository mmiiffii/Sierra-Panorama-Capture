name: Timelapse - one of 4 Cams

on:
  workflow_dispatch:
    inputs:
      camera:
        description: "Camera (matches folder under images/)"
        required: true
        type: choice
        options:
          - borreguiles
          - satelite
          - stadium
          - veleta
        default: borreguiles
      days_back:
        description: "How many days back (>= 1)"
        required: true
        type: number
        default: 1
      fps:
        description: "Frames per second"
        required: true
        type: number
        default: 24

permissions:
  contents: write

jobs:
  timelapse:
    runs-on: ubuntu-latest

    env:
      BRANCH: ${{ github.ref_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # if you prefer, you can switch to: pip install -r requirements.txt
          pip install numpy opencv-python-headless

      - name: Ensure output dir
        run: mkdir -p timelapses

      - name: Build timelapse video
        id: build
        env:
          CAMERA: ${{ github.event.inputs.camera }}
          DAYS: ${{ github.event.inputs.days_back }}
          FPS_IN: ${{ github.event.inputs.fps }}
          RUN_ID: ${{ github.run_id }}
        run: |
          echo "Camera folder : ${CAMERA}"
          echo "Days back     : ${DAYS}"
          echo "FPS           : ${FPS_IN}"

          OUT="timelapses/timelapse_${CAMERA}_last${DAYS}d_run${RUN_ID}.mp4"
          echo "Output path   : ${OUT}"

          python -u scripts/create_timelapse.py \
            --camera "${CAMERA}" \
            --days "${DAYS}" \
            --fps "${FPS_IN}" \
            --output "${OUT}"

          if [ ! -f "${OUT}" ]; then
            echo "ERROR: expected output video not found: ${OUT}"
            echo "Listing timelapses/ directory:"
            ls -l timelapses || echo "no timelapses dir?"
            exit 1
          fi

          echo "Timelapse created at: ${OUT}"
          ls -l "${OUT}"

      - name: Commit timelapse to repo (with retry)
        run: |
          if [ -n "$(git status --porcelain timelapses)" ]; then
            echo "Changes detected in timelapses/, committing..."
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            git add timelapses
            git commit -m "timelapse: ${{
              github.event.inputs.camera
            }} last ${{
              github.event.inputs.days_back
            }} days (run ${{
              github.run_number
            }})" || echo "Nothing to commit (maybe identical file)."

            # robust-ish push with a few retries
            for i in 1 2 3; do
              echo "Push attempt #$i to branch ${BRANCH}..."
              git pull --rebase origin "${BRANCH}" || echo "pull failed (probably fine on first push)."
              if git push origin HEAD:"${BRANCH}"; then
                echo "Push succeeded."
                break
              fi
              echo "Push failed, sleeping before retry..."
              sleep 5
            done
          else
            echo "No changes in timelapses/, nothing to commit."
          fi

      - name: Job summary
        if: always()
        run: |
          echo "## Timelapse (one of 4 cams)" >> "$GITHUB_STEP_SUMMARY"
          echo "- Camera folder : \`${{ github.event.inputs.camera }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Days back     : \`${{ github.event.inputs.days_back }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- FPS           : \`${{ github.event.inputs.fps }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Output        : \`timelapses/timelapse_${{ github.event.inputs.camera }}_last${{ github.event.inputs.days_back }}d_run${{ github.run_id }}.mp4\`" >> "$GITHUB_STEP_SUMMARY"
