name: Timelapse - one of 4 Cams

on:
  workflow_dispatch:
    inputs:
      camera:
        description: "Camera (matches folder under images/)"
        required: true
        type: choice
        options:
          - borreguiles
          - satelite
          - stadium
          - veleta
        default: borreguiles
      days_back:
        description: "How many days back (>= 1)"
        required: true
        type: number
        default: 1
      fps:
        description: "Frames per second"
        required: true
        type: number
        default: 24

permissions:
  contents: write

jobs:
  timelapse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # You can also do: pip install -r requirements.txt
          pip install numpy opencv-python-headless

      - name: Ensure output dir
        run: mkdir -p timelapses

      - name: Build timelapse video
        run: |
          CAM="${{ github.event.inputs.camera }}"
          DAYS="${{ github.event.inputs.days_back }}"
          FPS_IN="${{ github.event.inputs.fps }}"

          if [ -z "$FPS_IN" ]; then
            FPS_IN=24
          fi

          OUT="timelapses/timelapse_${CAM}_last${DAYS}d_run${{ github.run_id }}.mp4"

          echo "Camera folder : $CAM"
          echo "Days back     : $DAYS"
          echo "FPS           : $FPS_IN"
          echo "Output path   : $OUT"

          python -u scripts/create_timelapse.py \
            --camera "$CAM" \
            --days "$DAYS" \
            --fps "$FPS_IN" \
            --output "$OUT"

          if [ ! -f "$OUT" ]; then
            echo "ERROR: expected output video not found: $OUT"
            echo "Listing timelapses/:"
            ls -l timelapses || echo "no timelapses dir?"
            exit 1
          fi

          echo "Timelapse created at: $OUT"
          ls -l "$OUT"

      - name: Publish MP4 to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: timelapse-${{ github.event.inputs.camera }}-run-${{ github.run_id }}
          name: Timelapse - ${{ github.event.inputs.camera }} (run ${{ github.run_number }})
          body: |
            Timelapse for camera folder: ${{ github.event.inputs.camera }}
            Days back: ${{ github.event.inputs.days_back }}
            FPS: ${{ github.event.inputs.fps }}

            Generated by GitHub Actions (run ${{ github.run_number }}).
          files: timelapses/timelapse_${{ github.event.inputs.camera }}_last${{ github.event.inputs.days_back }}d_run${{ github.run_id }}.mp4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: always()
        run: |
          echo "## Timelapse (one of 4 cams)" >> "$GITHUB_STEP_SUMMARY"
          echo "- Camera folder : \`${{ github.event.inputs.camera }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Days back     : \`${{ github.event.inputs.days_back }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- FPS           : \`${{ github.event.inputs.fps }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Output        : attached to the new Release" >> "$GITHUB_STEP_SUMMARY"
