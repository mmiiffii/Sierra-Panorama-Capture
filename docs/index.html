<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sierra Nevada — Webcam Archive</title>

<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #111;
    color: #eee;
    overflow-x: hidden;
  }
  header {
    padding: 1rem;
    background: #000;
    position: sticky;
    top: 0;
    z-index: 10;
    display: flex;
    gap: 1rem;
    align-items: center;
    border-bottom: 1px solid #333;
  }
  select, button {
    background: #222;
    color: #eee;
    border: 1px solid #444;
    padding: 0.4rem 0.6rem;
    border-radius: 4px;
  }
  #viewer {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
  }
  img {
    max-width: 100vw;
    max-height: 85vh;
    border-radius: 6px;
    transition: opacity 0.15s ease-out;
  }
  #timestamp {
    text-align: center;
    margin-top: 0.5rem;
    color: #aaa;
    font-size: 1rem;
  }
  #slider {
    width: 95%;
    margin: 1.2rem auto;
  }
  #debug {
    margin: 1rem auto;
    text-align: center;
    color: #888;
  }
</style>
</head>

<body>

<header>
  <strong>Sierra Nevada — Archive</strong>

  <label>Camera:</label>
  <select id="camera"></select>

  <label>Day:</label>
  <select id="day"></select>
</header>

<div id="viewer">
  <img id="frame" src="" alt="webcam frame">
</div>

<div id="timestamp"></div>

<input id="slider" type="range" min="0" max="0" value="0" />

<div id="debug"></div>

<script>
/* ---------------------------
   CONFIG
---------------------------- */
const CAMERAS = {
  borreguiles: { name: "Borreguiles" },
  stadium: { name: "Stadium" },
  satellite: { name: "Satelite" },
  veleta: { name: "Veleta" }
};

const cameraSel = document.querySelector("#camera");
const daySel    = document.querySelector("#day");
const slider    = document.querySelector("#slider");
const img       = document.querySelector("#frame");
const ts        = document.querySelector("#timestamp");

/* Populate camera dropdown */
Object.entries(CAMERAS).forEach(([key, cfg]) => {
  const opt = document.createElement("option");
  opt.value = key;
  opt.textContent = cfg.name;
  cameraSel.appendChild(opt);
});

let manifest = null;

/* ---- Fetch list of days ---- */
async function loadDays(camera) {
  daySel.innerHTML = "";
  try {
    const r = await fetch(`docs/${camera}/index.json`);
    const days = await r.json();
    days.reverse().forEach(d => {
      const opt = document.createElement("option");
      opt.value = d;
      opt.textContent = d;
      daySel.appendChild(opt);
    });
  } catch (err) {
    console.error(err);
  }
}

/* ---- Fetch manifest for selected day ---- */
async function loadManifest() {
  const camera = cameraSel.value;
  const day = daySel.value;
  const url = `docs/${camera}/${day}.json`;

  const r = await fetch(url);
  manifest = await r.json();

  slider.max = manifest.frames.length - 1;
  slider.value = manifest.frames.length - 1;
  showFrame();
}

/* ---- Display frame ---- */
function showFrame() {
  if (!manifest) return;
  const idx = Number(slider.value);
  const file = manifest.frames[idx].file;
  const time = manifest.frames[idx].time;

  img.style.opacity = 0;
  img.onload = () => (img.style.opacity = 1);
  img.src = `../images/${manifest.camera}/${manifest.day}/${file}`;
  ts.textContent = time;

  /* Preload neighbours */
  preload(idx - 1);
  preload(idx + 1);
}

function preload(i) {
  if (i < 0 || i >= manifest.frames.length) return;
  const file = manifest.frames[i].file;
  const p = new Image();
  p.src = `../images/${manifest.camera}/${manifest.day}/${file}`;
}

/* ---- Init ---- */
cameraSel.onchange = async () => {
  await loadDays(cameraSel.value);
  await loadManifest();
};

daySel.onchange = loadManifest;
slider.oninput = showFrame;

(async () => {
  await loadDays("borreguiles");
  cameraSel.value = "borreguiles";
  await loadManifest();
})();
</script>

</body>
</html>
